# Basic terminal setup - WORKING
set -ga terminal-overrides ",screen-256color*:Tc"
set-option -g default-terminal "screen-256color"
set -s escape-time 0

# Plugin Manager (TPM) - Essential plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'rickstaa/tmux-notify'


# Prefix key change 
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Basic bindings 
bind r source-file ~/.config/tmux/.tmux.conf
set -g base-index 1

# Vi mode - COMMENTED OUT FOR TESTING
# set-window-option -g mode-keys vi
# bind -T copy-mode-vi v send-keys -X begin-selection
# bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# vim-like pane switching
bind -r ^ last-window

bind-key -n C-k select-pane -U
bind-key -n C-j select-pane -D
bind-key -n C-h select-pane -L
bind-key -n C-l select-pane -R

# Pane resizing
bind-key -n C-M-h resize-pane -L 5
bind-key -n C-M-j resize-pane -D 5
bind-key -n C-M-k resize-pane -U 5
bind-key -n C-M-l resize-pane -R 5

# Better split bindings
bind f split-window -h -c "#{pane_current_path}"
bind g split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# # Mouse support 
set -g mouse on

# # Window and pane numbering - 
set -g renumber-windows on
set -g pane-base-index 1

# # Smart pane switching with awareness of Vim splits 
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Alt window navigation (no prefix needed) 
bind -n M-H previous-window
bind -n M-L next-window


# ##### Popup System ##### 
#Ctrl+A + y = Lazygit popup
bind y display-popup \
   -d "#{pane_current_path}" \
   -w 80% \
   -h 80% \
   -E "lazygit"

# # Ctrl+A + j = Enhanced session switcher with delete/rename
bind j display-popup -E "~/.config/tmux/tmux-session-manager"

# # Ctrl+A + n = New session popup
bind n display-popup -E 'bash -i -c "read -p \"Session name: \" name; tmux new-session -d -s \$name && tmux switch-client -t \$name"'

# # Ctrl+A + t = Terminal popup
bind t display-popup \
   -d "#{pane_current_path}" \
   -w 75% \
   -h 75% \
   -E "zsh"

# # Ctrl+A + z = Edit zshrc
bind z display-popup \
   -w 80% \
   -h 80% \
   -E 'nvim ~/.zshrc'

# Search and replace  
bind-key s new-window -n serpl -c "#{pane_current_path}" "serpl"

# Zoom/focus toggle
bind-key z resize-pane -Z

# # Ctrl+A + d = Dotfiles menu
bind d display-menu -T "#[align=centre]Dotfiles" -x C -y C \
   "Zsh Config"        z  "display-popup -E 'nvim ~/.zshrc'" \
   "Tmux Config"       t  "display-popup -E 'nvim ~/.config/tmux/.tmux.conf'" \
   "Nvim Keymaps"      k  "display-popup -E 'nvim ~/.config/nvim/lua/config/keymaps.lua'" \
   "Wezterm Config"    w  "display-popup -E 'nvim ~/.config/wezterm/.wezterm.lua" \
   "Exit"              q  ""

# # tmux-sessionizer - changed from 'f' to 'F' to avoid conflict with split binding
bind-key -r k run-shell "tmux neww ~/.config/tmux/tmux-sessionizer"

# Dynamic theme configuration based on NVIM_COLORSCHEME environment variable
set -g status-position top

# Gruvbox-style pane borders - more prominent active pane
set -g pane-border-style 'fg=#504945'
set -g pane-active-border-style 'fg=#fabd2f,bg=#fabd2f'
set -g pane-border-lines heavy

# Run theme switcher script
run-shell "~/.config/tmux/theme-switcher.sh"

# Initialize TPM (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
